---
// src/layouts/Site.astro  — BASELINE NICE (stable)

const {
  title = "Fernie Real Estate",
  seo_title = title,
  seo_description = "",
  summary = "",
  showHeader = true,
  class: bodyClass = ""
} = Astro.props;

import { getJson } from "../lib/fetchJson";

/* helpers */
const RESERVED = new Set(["index","page","pages","all","view","list"]);
const getField = (r:any, k:string) =>
  (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "").toString().trim();
const visible = (r:any) => {
  const s = getField(r,"status").toLowerCase();
  const raw = getField(r,"slug").toLowerCase();
  return s !== "hidden" && s !== "inactive" && raw !== "index" && !RESERVED.has(raw);
};
type MenuItem = { title:string; slug:string };

async function loadMenu(url:string|undefined):Promise<MenuItem[]>{
  if(!url) return [];
  try{
    const raw = await getJson<any>(url);
    const rows = Array.isArray(raw) ? raw
      : Array.isArray(raw?.data) ? raw.data
      : Array.isArray(raw?.rows) ? raw.rows : [];
    return rows.filter(visible).map((r:any)=>({
      title:getField(r,"title"), slug:getField(r,"slug")
    }));
  }catch{ return []; }
}

const [neigh, types, extras, todo, stay] = await Promise.all([
  loadMenu(import.meta.env.PUBLIC_NEIGHBOURHOODS_JSON),
  loadMenu(import.meta.env.PUBLIC_TYPES_JSON),
  loadMenu(import.meta.env.PUBLIC_XTRA_JSON),
  loadMenu(import.meta.env.PUBLIC_TODO_JSON),
  loadMenu(import.meta.env.PUBLIC_STAY_JSON)
]);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{seo_title}</title>
    <meta name="description" content={seo_description} />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body class={bodyClass}>
    {showHeader && (
      <header class="site-header">
        <nav class="nav" aria-label="Main">
          <a href="/" class="brand">Fernie Real Estate</a>

          <!-- desktop -->
          <ul class="nav-list desktop">
            <li class="nav-item">
              <a class="nav-link" href="#">Neighbourhoods</a>
              <span class="hover-buffer"></span>
              <div class="nav-dd">
                {neigh.map(n => <a href={`/neighbourhoods/${n.slug}`}>{n.title}</a>)}
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Types</a>
              <span class="hover-buffer"></span>
              <div class="nav-dd">
                {types.map(n => <a href={`/types/${n.slug}`}>{n.title}</a>)}
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Other Areas</a>
              <span class="hover-buffer"></span>
              <div class="nav-dd">
                {extras.map(n => <a href={`/extra-areas/${n.slug}`}>{n.title}</a>)}
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">To Do</a>
              <span class="hover-buffer"></span>
              <div class="nav-dd">
                {todo.map(n => <a href={`/todo/${n.slug}`}>{n.title}</a>)}
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Stay</a>
              <span class="hover-buffer"></span>
              <div class="nav-dd">
                {stay.map(n => <a href={`/stay/${n.slug}`}>{n.title}</a>)}
              </div>
            </li>
            <li class="nav-item"><a class="nav-link" href="/search">Search</a></li>
            <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
          </ul>

          <!-- mobile: simple details (no JS) -->
          <div class="mobile">
            <details class="m-item">
              <summary>Neighbourhoods</summary>
              <div class="m-dd">{neigh.map(n => <a href={`/neighbourhoods/${n.slug}`}>{n.title}</a>)}</div>
            </details>
            <details class="m-item">
              <summary>Types</summary>
              <div class="m-dd">{types.map(n => <a href={`/types/${n.slug}`}>{n.title}</a>)}</div>
            </details>
            <details class="m-item">
              <summary>Other Areas</summary>
              <div class="m-dd">{extras.map(n => <a href={`/extra-areas/${n.slug}`}>{n.title}</a>)}</div>
            </details>
            <details class="m-item">
              <summary>To Do</summary>
              <div class="m-dd">{todo.map(n => <a href={`/todo/${n.slug}`}>{n.title}</a>)}</div>
            </details>
            <details class="m-item">
              <summary>Stay</summary>
              <div class="m-dd">{stay.map(n => <a href={`/stay/${n.slug}`}>{n.title}</a>)}</div>
            </details>
            <a class="m-link" href="/search">Search</a>
            <a class="m-link" href="/contact">Contact</a>
          </div>
        </nav>
      </header>
    )}

    <slot />
  </body>
</html>

<style is:global>
:root{
  --header-h: 52px;
  --ink:#111827;
  --hover-bg: rgba(243,244,246,.95);

  /* hero/map kept separate so this file never forces 100vh */
  --hero-h: 55vh;
  --hero-h-sm: 44vh;
  --map-h: clamp(420px, 50vh, 760px);
  --map-h-sm: clamp(360px, 60vh, 640px);

  /* dropdown look */
  --dd-bg: rgba(255,255,255,.96);
  --dd-shadow: 0 10px 28px rgba(0,0,0,.12);
  --dd-radius: 10px;
  --dd-blur: 8px;
}

*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
a{color:inherit;text-decoration:none}

/* header */
.site-header{position:relative;z-index:50;background:#fff;box-shadow:0 1px 0 rgba(17,24,39,.06)}
.nav{max-width:1200px;margin:0 auto;height:var(--header-h);display:flex;align-items:center;gap:.75rem;padding:0 1rem}
.brand{font-weight:800;white-space:nowrap}

/* desktop */
.desktop{display:flex;align-items:center;gap:.25rem;margin-left:auto;padding:0;list-style:none}
.nav-item{position:relative}
.nav-link{display:inline-block;padding:.45rem .85rem;border-radius:8px}
.nav-link:hover{background:var(--hover-bg)}

/* dropdown — non-blobby */
.nav-dd{
  position:absolute; top:calc(100% + 10px); left:0; min-width:240px;
  background:var(--dd-bg); box-shadow:var(--dd-shadow); border-radius:var(--dd-radius);
  padding:8px 0; backdrop-filter:blur(var(--dd-blur));
  opacity:0; visibility:hidden; transform:translateY(-6px);
  transition:opacity .18s ease, transform .18s ease, visibility .18s step-end;
}
.nav-dd a{display:block;padding:9px 14px;border-radius:6px}
.nav-dd a:hover{background:rgba(0,0,0,.05)}

/* buffer so hover doesn’t collapse when moving down */
.hover-buffer{position:absolute;left:0;right:0;top:100%;height:12px;display:block}

/* show dropdown on hover/focus */
.nav-item:hover>.nav-dd,
.nav-item:focus-within>.nav-dd{
  opacity:1; visibility:visible; transform:translateY(0);
  transition:opacity .18s ease, transform .18s ease, visibility 0s;
}

/* mobile (no JS, no hamburger) */
.mobile{display:none;gap:8px;margin-left:auto}
.m-item{border:1px solid rgba(17,24,39,.08);border-radius:10px;background:#fff}
.m-item>summary{padding:10px 12px;cursor:pointer;list-style:none}
.m-item[open]>summary{background:rgba(17,24,39,.03)}
.m-dd{display:flex;flex-direction:column}
.m-dd a{padding:9px 12px;border-top:1px solid rgba(17,24,39,.06)}
.m-link{display:block;padding:10px 12px;border:1px solid rgba(17,24,39,.08);border-radius:10px;background:#fff}

/* responsive */
@media (max-width: 900px){
  .desktop{display:none}
  .mobile{display:flex}
}

/* keep hero/map independent from header hacks */
.hero, .hero-bleed{position:relative}
.hero-bleed>img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.map-wrap{height:var(--map-h)}
@media (max-width: 900px){ .map-wrap{height:var(--map-h-sm)} }
</style>
