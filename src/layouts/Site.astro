---
// File: src/layouts/Site.astro
const {
  title = "Fernie Real Estate",
  seo_title = title,
  seo_description = "",
  summary = "",
  showHeader = true,
  class: bodyClass = "",
  heroPreload = null as null | {
    href: string;
    imagesrcset?: string;
    imagesizes?: string;
    as?: "image";
    type?: string;
    crossorigin?: "" | "anonymous" | "use-credentials";
  }
} = Astro.props;

import { getJson } from "../lib/fetchJson";

/* ---------- helpers ---------- */
const RESERVED = new Set(["index","page","pages","all","view","list"]);
const getField = (r:any, k:string) =>
  (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "").toString().trim();
const visible = (r:any) => {
  const s = getField(r, "status").toLowerCase();
  const rawSlug = getField(r, "slug").toLowerCase();
  return s !== "hidden" && s !== "inactive" && rawSlug !== "index" && !RESERVED.has(rawSlug);
};
type MenuItem = { title:string; slug:string; sort:number };

async function fetchMenuSafe(url?: string): Promise<MenuItem[]> {
  if (!url) return [];
  try { new URL(url, "http://x"); } catch { return []; }

  try {
    const raw = await getJson<any>(url);
    const rows:any[] =
      Array.isArray(raw) ? raw :
      Array.isArray(raw?.data) ? raw.data :
      Array.isArray(raw?.rows) ? raw.rows : [];

    const out: MenuItem[] = [];
    for (const r of rows) {
      if (!visible(r)) continue;
      const title = getField(r, "title");
      const slug = getField(r, "slug");
      if (!title || !slug) continue;
      const sort = Number.isFinite(+r?.sort) ? +r.sort : Number.MAX_SAFE_INTEGER;
      out.push({ title, slug, sort });
    }
    out.sort((a,b) => (a.sort - b.sort) || a.title.localeCompare(b.title));
    return out;
  } catch (e) {
    console.warn("[fetchMenuSafe] using empty menu for", url, e);
    return [];
  }
}

/* ---------- build menus (safe) ---------- */
const neighbourhoods:MenuItem[] = await fetchMenuSafe(import.meta.env.PUBLIC_SHEET_JSON);
const typesMenu:MenuItem[]      = await fetchMenuSafe(import.meta.env.PUBLIC_TYPES_JSON);
const xtraMenu:MenuItem[]       = await fetchMenuSafe(import.meta.env.PUBLIC_XTRAAREA_JSON);
await fetchMenuSafe(import.meta.env.PUBLIC_TODO_JSON);

/* ---------- misc ---------- */
const metaDescription = (seo_description || summary || "").toString().trim();

/* ---------- nav order ---------- */
const NAV_ORDER = [
  "neighbourhoods",
  "types",
  "xtra",
  "todo",
  "stay",
  "contact",
] as const;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{seo_title}</title>
    {metaDescription && <meta name="description" content={metaDescription} />}

    <!-- ðŸš€ perf hints -->
    <link rel="preconnect" href="https://cdn.realtyvis.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.realtyvis.com">
    <link rel="dns-prefetch" href="https://api.realtyvis.com">
    <link rel="preconnect" href="https://api.realtyvis.com" crossorigin>

    <!-- âœ… NEW: Warm up RealtyVis app origin (handshake + TCP/TLS) -->
    <link rel="dns-prefetch" href="https://app.realtyvis.com">
    <link rel="preconnect"  href="https://app.realtyvis.com" crossorigin>

    <!-- âœ… NEW: Light prefetch of RV core assets (safe passive hints) -->
    <link rel="prefetch" href="https://app.realtyvis.com/js/site.min.js" as="script" crossorigin>
    <link rel="prefetch" href="https://app.realtyvis.com/css/site.min.css" as="style" crossorigin>

    <!-- âœ… preload hero (when provided) -->
    {heroPreload && (
      <link
        rel="preload"
        as={heroPreload.as || "image"}
        href={heroPreload.href}
        { ...(heroPreload.imagesrcset ? { imagesrcset: heroPreload.imagesrcset } : {}) }
        { ...(heroPreload.imagesizes ? { imagesizes: heroPreload.imagesizes } : { imagesizes: "100vw" }) }
        { ...(heroPreload.type ? { type: heroPreload.type } : {}) }
        { ...(heroPreload.crossorigin ? { crossorigin: heroPreload.crossorigin } : {}) }
      />
    )}

    <slot name="head" />

    <!-- ðŸŒŸ Minimal LCP helpers -->
    <style>
      @media (max-width:900px){
        header nav{ display:none !important; }
        header nav.open{ display:flex !important; }
      }
    </style>

    <!-- âœ¨ global styles -->
    <style is:global>
      :root {
        --header-h: 52px;
        --bg:#2f311010; --ink:#271f11; --ink-muted:#1f2937; --hover-bg:rgba(243,244,246,.9);
        --hero-h: 55vh;
        --hero-min: 240px;
        --container-pad: 12px;
        --container-max: 1200px;
        --bleed-fix: 2px;
        --card-text-lines: 3;
        --card-text-lh: 1.35;
      }
      *,*::before,*::after { box-sizing:border-box; }
      html,body { height:100%; overflow-x:clip; margin:0; }
      body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background: var(--bg); color: var(--ink); }
      .container { max-width: var(--container-max); margin-inline: auto; padding-inline: var(--container-pad); }
      header { position: fixed; top: 0; left: 0; right: 0; height: var(--header-h); background: rgba(255,255,255,.84); backdrop-filter: blur(10px); border-bottom: 1px solid #e5e7eb; z-index: 1000; }
      .nav-inner { width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 max(16px, env(safe-area-inset-right)) 0 max(16px, env(safe-area-inset-left)); gap: 10px; }
      .brand { font-weight: 700; font-size: 1rem; color: var(--ink); text-decoration: none; padding: 4px 6px; border-radius: 6px; white-space: nowrap; }
      .brand:hover { background: var(--hover-bg); }
      nav { display: flex; align-items: center; gap: 15px; justify-content: flex-end; flex: 1 1 auto; }
      nav a { color: var(--ink-muted); padding: 6px 8px; text-decoration: none; border-radius: 8px; font-weight: 500; }
      nav a:hover, nav a:focus-visible { color: var(--ink); background: var(--hover-bg); }
      .hamburger { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ink-muted); }
      @media (max-width:900px){
        header nav { position: absolute; top: var(--header-h); right: 0; background: #fff; flex-direction: column; gap: 0; padding: 8px 12px; box-shadow: 0 2px 8px rgba(0,0,0,.1); width: auto; max-width: 92vw; min-width: 220px; }
        header nav a { display: block; width: 100%; padding: 10px; }
        .hamburger { display: block; margin-left: auto; }
      }
      footer.site-footer { width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(6px); border-top: 1px solid #e5e7eb; padding: 1rem 0; margin-top: 3rem; text-align: center; font-size: .875rem; color: #4b5563; }
    </style>

    <script is:inline>
      function toggleNav(){
        const nav=document.querySelector("header nav");
        const btn=document.querySelector(".hamburger");
        if(!nav||!btn)return;
        const isOpen=nav.classList.toggle("open");
        btn.setAttribute("aria-expanded",String(isOpen));
      }
      window.toggleNav=toggleNav;
      document.addEventListener("DOMContentLoaded",()=>{ const nav=document.querySelector("header nav"); if(nav) nav.classList.remove("open"); });
    </script>

    <script is:inline src="/js/smooth-anchors.js"></script>

    <!-- ðŸ§­ RealtyVis â€” load globally so embeds never hang -->
    <link rel="preload" href="https://cdn.realtyvis.com/js/embed.js" as="script">
    <script src="https://cdn.realtyvis.com/js/embed.js" async></script>
  </head>

  <body class={bodyClass}>
    <a class="skip-link" href="#main">Skip to main content</a>

    {showHeader && (
      <header role="banner">
        <div class="nav-inner">
          <a class="brand" href="/" data-astro-prefetch>Fernie.Homes</a>
          <button class="hamburger" onclick="toggleNav()" aria-label="Open menu" aria-expanded="false">â˜°</button>
          <nav aria-label="Primary">
            {
              NAV_ORDER.map((key) => {
                switch (key) {
                  case "neighbourhoods": return <a href="/neighbourhoods" data-astro-prefetch="hover">Neighbourhoods</a>;
                  case "types": return <a href="/types" data-astro-prefetch="hover">Property Types</a>;
                  case "xtra": return <a href="/xtraarea" data-astro-prefetch="hover">Other Areas</a>;
                  case "todo": return <a href="/to_do" data-astro-prefetch="hover">To Do</a>;
                  case "stay": return <a href="/stay" data-astro-prefetch="hover">Stay</a>;
                  case "contact": return <a href="/contact" data-astro-prefetch>Contact</a>;
                }
              })
            }
          </nav>
        </div>
      </header>
    )}

    <main id="main" role="main">
      <slot name="hero" />
      <div class="below-fold">
        <slot />
      </div>
    </main>

    <footer class="site-footer" role="contentinfo">
      <div class="container">
        <p>&copy; {new Date().getFullYear()} Fernie Real Estate. All rights reserved.</p>
        <div class="footer-links">
          <a href="/privacy" data-astro-prefetch>Privacy Policy</a>
          <a href="/terms" data-astro-prefetch>Terms of Use</a>
          <a href="/contact" data-astro-prefetch>Contact</a>
        </div>
      </div>
    </footer>
  </body>
</html>
