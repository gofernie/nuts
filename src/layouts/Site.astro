---
/* File: src/layouts/Site.astro */
const {
  title = "Fernie Real Estate",
  seo_title = title,
  seo_description = "",
  summary = "",
  showHeader = true,
  class: bodyClass = ""
} = Astro.props;

import { getJson } from "../lib/fetchJson";

/* ---------- helpers ---------- */
const RESERVED = new Set(["index","page","pages","all","view","list"]);
const getField = (r:any, k:string) =>
  (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "").toString().trim();
const visible = (r:any) => {
  const s = getField(r, "status").toLowerCase();
  const raw = getField(r, "slug").toLowerCase();
  return s !== "hidden" && s !== "inactive" && raw !== "index" && !RESERVED.has(raw);
};
type MenuItem = { title:string; slug:string; sort:number };

/** Safe path join that encodes each segment */
const joinPath = (base:string, slug:string) => {
  const clean = (slug || "").replace(/^\/+/, "");
  const esc = clean.split("/").map(encodeURIComponent).join("/");
  return `${base}/${esc}`;
};

async function fetchMenuSafe(url?: string): Promise<MenuItem[]> {
  if (!url) return [];
  try { new URL(url, "http://x"); } catch { return []; }
  try {
    const raw = await getJson<any>(url);
    const rows:any[] =
      Array.isArray(raw) ? raw :
      Array.isArray(raw?.data) ? raw.data :
      Array.isArray(raw?.rows) ? raw.rows : [];
    const out: MenuItem[] = [];
    for (const r of rows) {
      if (!visible(r)) continue;
      const title = getField(r, "title");
      const slug  = getField(r, "slug");
      if (!title || !slug) continue;
      const sort = Number.isFinite(+r?.sort) ? +r.sort : Number.MAX_SAFE_INTEGER;
      out.push({ title, slug, sort });
    }
    out.sort((a,b) => (a.sort - b.sort) || a.title.localeCompare(b.title));
    return out;
  } catch { return []; }
}

/* ---------- build menus ---------- */
const neighbourhoods:MenuItem[] = await fetchMenuSafe(import.meta.env.PUBLIC_SHEET_JSON);
const typesMenu:MenuItem[]      = await fetchMenuSafe(import.meta.env.PUBLIC_TYPES_JSON);
const xtraMenu:MenuItem[]       = await fetchMenuSafe(import.meta.env.PUBLIC_XTRAAREA_JSON);

/* ---------- misc ---------- */
const ROWS_PER_COL = 7;
const colsFor = (n:number) => Math.min(6, Math.ceil(n / ROWS_PER_COL));
const metaDescription = (seo_description || summary || "").toString().trim();

/* ---------- nav order ---------- */
const NAV_ORDER = ["neighbourhoods","types","xtra","todo","stay","search","contact"] as const;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{seo_title}</title>
    {metaDescription && <meta name="description" content={metaDescription} />}
    <slot name="head" />

    <style>
      :root {
        --header-h: 52px;
        --bg:#e49e1c0a; --ink:#111827; --ink-muted:#1f2937; --hover-bg:rgba(243,244,246,.9);
        --hero-h:65vh; --hero-h-sm:44vh;
        --map-h: clamp(420px, 50vh, 760px);
        --map-h-sm: clamp(360px, 60vh, 640px);
        --container-pad:12px; --bleed-fix:2px;
      }
      *,*::before,*::after { box-sizing:border-box; }
      html, body { height:100%; overflow-x:clip; }
      body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }

      header{
        position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:1000;
        background:rgba(255,255,255,.84); backdrop-filter:blur(10px); border-bottom:1px solid #e5e7eb;
      }
      .nav-inner{
        height:100%;
        padding:0 max(16px, env(safe-area-inset-right)) 0 max(16px, env(safe-area-inset-left));
        display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:nowrap;
      }
      .brand{font-weight:700;font-size:1rem;color:var(--ink);text-decoration:none;padding:4px 6px;border-radius:6px;white-space:nowrap;flex:0 0 auto;}
      .brand:hover{background:var(--hover-bg);}
      .hamburger{display:block;margin-left:auto;background:none;border:none;font-size:1.6rem;line-height:1;cursor:pointer;color:var(--ink-muted);}
      @media (min-width:901px) and (hover:hover){.hamburger{display:none;}}
      #site-nav{display:none;position:absolute;top:var(--header-h);right:0;background:#fff;z-index:1200;flex-direction:column;gap:0;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,.1);width:auto;max-width:92vw;min-width:220px;}
      #site-nav.open{display:flex;}
      nav a{color:var(--ink-muted);padding:6px 8px;text-decoration:none;border-radius:8px;font-weight:500;display:block;white-space:normal;}
      nav a:hover,nav a:focus-visible{color:var(--ink);background:var(--hover-bg);}
      .menu-group{width:100%;position:relative;margin:6px 0;}
      .menu-link.has-sub{display:flex;align-items:center;justify-content:space-between;}
      .menu-link.has-sub::after{content:"â–¾";opacity:.8;margin-left:8px;transition:transform .2s ease;}
      .dropdown{position:static;display:block;overflow:hidden;max-height:0;transition:max-height .28s ease;}
      .menu-group.expanded>.menu-link.has-sub{font-weight:600;}
      .menu-group.expanded>.menu-link.has-sub::after{transform:rotate(180deg);}
      .menu-group.expanded>.dropdown{max-height:520px;overflow:auto;margin:6px 0 10px;padding:8px 6px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);border:1px solid #eceef2;}
      @media (min-width:901px) and (hover:hover){
        #site-nav{position:static;display:flex;flex-direction:row;align-items:center;gap:8px;padding:0;box-shadow:none;background:transparent;}
        nav a{display:inline-flex;white-space:nowrap;color:var(--ink-muted);padding:6px 8px;text-decoration:none;}
        .menu-group{width:auto;margin:0;}
        .dropdown{position:absolute;left:0;top:calc(100% + 21px);background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border:1px solid rgba(229,231,235,.7);border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);display:grid;grid-auto-flow:column;grid-template-rows:repeat(7,auto);gap:6px 12px;padding:10px;width:max-content;max-width:92vw;opacity:0;transform:translateY(-12px);pointer-events:none;transition:transform .28s cubic-bezier(.2,.7,.2,1),opacity .22s ease-out;z-index:1100;}
        .menu-group::before{content:"";position:absolute;top:100%;left:-12px;right:-12px;height:40px;}
        .menu-group:hover>.dropdown,.menu-group:focus-within>.dropdown{opacity:1;transform:translateY(0);pointer-events:auto;}
      }
    </style>

    <style is:global>
      html{scroll-behavior:smooth;}
      :target{scroll-margin-top:calc(var(--header-h)+12px);}
      .hero-bleed{position:relative;left:50%;right:50%;width:calc(100vw + var(--bleed-fix)*2);margin-left:calc(-50vw - var(--bleed-fix));margin-right:calc(-50vw - var(--bleed-fix));height:clamp(var(--hero-h-sm),65vh,var(--hero-h));padding-top:var(--header-h);background-color:#e5e7eb;border-bottom:1px solid #eee;overflow:hidden;isolation:isolate;}
      .hero-bleed>img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;display:block;}
      .container{max-width:1200px;margin-inline:auto;padding-inline:var(--container-pad);}
      .rv-wrap,#rv-wrap-neigh{min-height:var(--map-h);overflow-anchor:auto;transition:min-height .3s ease;}
      @media(max-width:900px){.rv-wrap,#rv-wrap-neigh{min-height:var(--map-h-sm);}}
      .rv-wrap.rv-loaded,#rv-wrap-neigh.rv-loaded{min-height:auto;}
    </style>

    <script is:inline>
      function toggleNav(){
        const nav=document.getElementById("site-nav");
        const btn=document.getElementById("hamburger");
        if(!nav||!btn)return;
        const open=nav.classList.toggle("open");
        btn.setAttribute("aria-expanded",String(open));
        if(!open){nav.querySelectorAll(".menu-group.expanded").forEach(g=>g.classList.remove("expanded"));}
      }
      document.addEventListener("click",e=>{
        const link=e.target.closest(".menu-link.has-sub");
        if(!link)return;
        if(window.matchMedia("(min-width:901px) and (hover:hover)").matches)return;
        e.preventDefault();
        const nav=document.getElementById("site-nav");
        const group=link.closest(".menu-group");
        const expanded=group.classList.contains("expanded");
        nav.querySelectorAll(".menu-group.expanded").forEach(g=>{if(g!==group)g.classList.remove("expanded")});
        group.classList.toggle("expanded",!expanded);
      },true);
    </script>

    <script is:inline>
      (function(){
        const SEL=['#rv-wrap-neigh','.rv-wrap','[data-rv-block]'];
        function getWrap(el){if(!el)return null;if(el.id==='rv-wrap-neigh'||el.classList?.contains('rv-wrap'))return el;const w=el.closest?.('#rv-wrap-neigh,.rv-wrap');if(w)return w;el.classList?.add('rv-wrap');return el;}
        function markLoaded(w){if(!w)return;w.classList.add('rv-loaded');w.style.minHeight='auto';}
        function looksLoaded(w){return w&&(w.querySelector('.rv-block,iframe,[id^=\"mrp\"],[class*=\"mrp\"]'))&&w.offsetHeight>120;}
        function observe(w){if(!w)return;if(!w.style.minHeight)w.style.minHeight='var(--map-h)';const obs=new MutationObserver(()=>{if(looksLoaded(w)){markLoaded(w);obs.disconnect();}});obs.observe(w,{childList:true,subtree:true});setTimeout(()=>markLoaded(w),6000);}
        function boot(){const seen=new Set();SEL.forEach(s=>document.querySelectorAll(s).forEach(el=>{const w=getWrap(el);if(w&&!seen.has(w)){seen.add(w);observe(w);}}));const rootObs=new MutationObserver(m=>{m.forEach(x=>x.addedNodes.forEach(n=>{if(!(n instanceof Element))return;SEL.forEach(s=>{if(n.matches?.(s))observe(getWrap(n));n.querySelectorAll?.(s).forEach(el=>observe(getWrap(el)));});}));});rootObs.observe(document.documentElement,{childList:true,subtree:true});}
        if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',boot);}else{boot();}
      })();
    </script>

    <style is:global>
      .rv-block .rv-listingGrid,
      .rv-block [class*="rv-listingGrid"]{display:grid!important;gap:1rem!important;align-items:stretch;}
      .rv-block .rv-listingGrid>*,
      .rv-block [class*="rv-listingGrid"]>*{background:#ffffff00;border:0px solid #e5e7eb;border-radius:5px;box-shadow:0 2px 6px rgba(0,0,0,0.06);overflow:hidden;transition:transform .25s ease,box-shadow .25s ease;}
      .rv-block .rv-listingGrid>*:hover,
      .rv-block [class*="rv-listingGrid"]>*:hover{transform:translateY(-6px);box-shadow:0 8px 20px rgba(0,0,0,0.12);}
      @media(max-width:900px){.rv-block .rv-listingGrid,.rv-block [class*="rv-listingGrid"]{gap:.8rem!important;}}
      @media(max-width:600px){.rv-block .rv-listingGrid,.rv-block [class*="rv-listingGrid"]{gap:.6rem!important;}}
      .rv-block img{border-radius:5px;}
      .rv-block h2,.rv-block h3,.rv-block h4{margin-top:.5em;margin-bottom:.4em;}
      body{background-color:#fafaf9;}
    </style>

    <!-- FINAL: identical summary & long-copy -->
    <style is:global>
      :where(.summary),
      :where(.long-copy),
      :where(.summary p),
      :where(.long-copy p){
        font-family:inherit!important;
        font-size:clamp(1.05rem,1vw + .6rem,1.15rem)!important;
        line-height:1.65!important;
        font-weight:400!important;
        color:var(--ink)!important;
        margin:0 0 1em!important;
      }
      :where(.summary strong,.summary em,.summary a,
             .long-copy strong,.long-copy em,.long-copy a){
        color:inherit!important;
        font-weight:inherit!important;
      }
      .summary + .long-copy{margin-top:-0.25em!important;}
    </style>
  </head>

  <body class={bodyClass}>
    {showHeader && (
      <header>
        <div class="nav-inner">
          <a class="brand" href="/" data-astro-prefetch>Fernie Real Estate</a>
          <button id="hamburger" class="hamburger" onclick="toggleNav()">â˜°</button>
          <nav id="site-nav">
            {NAV_ORDER.map((key)=>{
              switch(key){
                case"neighbourhoods":return(<div class="menu-group"><a class="menu-link has-sub" href="/neighbourhoods">Neighbourhoods</a><div class="dropdown"><a class="view-all" href="/neighbourhoods">ALL NEIGHBOURHOODS</a>{neighbourhoods.map(n=>(<a href={joinPath("/neighbourhoods",n.slug)}>{n.title}</a>))}</div></div>);
                case"types":return(<div class="menu-group"><a class="menu-link has-sub" href="/types">Types</a><div class="dropdown"><a class="view-all" href="/types">ALL PROPERTY TYPES</a>{typesMenu.map(t=>(<a href={joinPath("/types",t.slug)}>{t.title}</a>))}</div></div>);
                case"xtra":return(<div class="menu-group"><a class="menu-link has-sub" href="/xtraarea">Other Areas</a><div class="dropdown"><a class="view-all" href="/xtraarea">ALL OTHER AREAS</a>{xtraMenu.map(x=>(<a href={joinPath("/xtraarea",x.slug)}>{x.title}</a>))}</div></div>);
                case"todo":return(<div class="menu-group"><a class="menu-link has-sub" href="/to_do">To Do</a><div class="dropdown"><a class="view-all" href="/to_do">ALL THINGS TO DO</a><a href="/to_do#summer">Summer</a><a href="/to_do#winter">Winter</a></div></div>);
                case"stay":return(<div class="menu-group"><a class="menu-link has-sub" href="/stay">Stay</a><div class="dropdown"><a class="view-all" href="/stay">ALL PLACES TO STAY</a><a href="/stay#hotels">Hotels</a><a href="/stay#airbnb">Airbnb</a></div></div>);
                case"search":return(<a class="menu-link" href="/search">Search</a>);
                case"contact":return(<a class="menu-link" href="/contact">Contact</a>);
              }
            })}
          </nav>
        </div>
      </header>
    )}

    <main><slot /></main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; {new Date().getFullYear()} Fernie Real Estate. All rights reserved.</p>
        <div class="footer-links">
          <a href="/privacy">Privacy Policy</a>
          <a href="/terms">Terms of Use</a>
          <a href="/contact">Contact</a>
        </div>
      </div>
    </footer>
  </body>
</html>
