---
/**
 * WeatherReport.astro ‚Äî Fernie Alpine Resort
 * Uses Open-Meteo for current weather + 3-day forecast
 * No API key required
 */

const LAT = 49.5043;
const LON = -115.0910;
const TZ  = "America/Edmonton";

// Build API URL
const url = new URL("https://api.open-meteo.com/v1/forecast");
url.searchParams.set("latitude", String(LAT));
url.searchParams.set("longitude", String(LON));
url.searchParams.set("current", "temperature_2m,apparent_temperature,wind_speed_10m,weather_code");
url.searchParams.set("daily", "temperature_2m_max,temperature_2m_min,weather_code");
url.searchParams.set("timezone", TZ);
url.searchParams.set("forecast_days", "3");

let data: any = null;
let err: string | null = null;
try {
  const res = await fetch(url.toString(), { headers: { "cache-control": "no-cache" } });
  if (!res.ok) throw new Error(`Open-Meteo HTTP ${res.status}`);
  data = await res.json();
} catch (e:any) {
  err = e?.message || "Failed to load weather data";
}

// Helper to map weather codes to icon/text
const weatherMap: Record<number, { icon: string; text: string }> = {
  0: { icon: "‚òÄÔ∏è", text: "Clear" },
  1: { icon: "üå§Ô∏è", text: "Mostly Clear" },
  2: { icon: "‚õÖ", text: "Partly Cloudy" },
  3: { icon: "‚òÅÔ∏è", text: "Cloudy" },
  45: { icon: "üå´Ô∏è", text: "Fog" },
  48: { icon: "üå´Ô∏è", text: "Rime Fog" },
  51: { icon: "üå¶Ô∏è", text: "Light Drizzle" },
  61: { icon: "üåßÔ∏è", text: "Rain" },
  71: { icon: "üå®Ô∏è", text: "Snow" },
  80: { icon: "üåßÔ∏è", text: "Showers" },
  95: { icon: "‚õàÔ∏è", text: "Thunderstorm" },
};

const currentTemp = data?.current?.temperature_2m;
const currentWind = data?.current?.wind_speed_10m;
const currentCode = data?.current?.weather_code;
const currentWx   = weatherMap[currentCode] ?? { icon: "‚ùì", text: "Unknown" };

const forecastDays = data?.daily?.time?.map((t:string, i:number) => {
  const date = new Date(`${t}T00:00:00`);
  const label = date.toLocaleDateString("en-CA", { weekday: "short", month: "short", day: "numeric" });
  const code = data.daily.weather_code[i];
  const wx = weatherMap[code] ?? { icon: "‚ùì", text: "?" };
  return {
    label,
    max: Math.round(data.daily.temperature_2m_max[i]),
    min: Math.round(data.daily.temperature_2m_min[i]),
    icon: wx.icon,
    text: wx.text
  };
}) ?? [];
---

<div class="weather-card" role="region" aria-label="Fernie Alpine Resort weather">
  <div class="current">
    <div class="icon">{currentWx.icon}</div>
    <div class="temp">
      <span class="big">{Math.round(currentTemp)}¬∞C</span>
      <span class="desc">{currentWx.text}</span>
      <span class="wind">üí® {Math.round(currentWind)} km/h</span>
    </div>
  </div>

  <div class="forecast">
    {forecastDays.map(d => (
      <div class="day">
        <span class="label">{d.label}</span>
        <span class="icon">{d.icon}</span>
        <span class="range">{d.min}¬∞ / {d.max}¬∞</span>
      </div>
    ))}
  </div>

  <div class="fine">
    Source: <a href="https://open-meteo.com/" rel="nofollow noopener">Open-Meteo</a> ¬∑
    TZ: {TZ}
    {err && <span class="err"> ¬∑ {err}</span>}
  </div>
</div>

<style>
  .weather-card {
    --pad: 12px;
    --radius: 16px;
    --muted: #5e737f;
    --line: rgba(0,0,0,.08);
    background: white;
    border-radius: var(--radius);
    box-shadow: 0 6px 24px rgba(0,0,0,.06);
    padding: calc(var(--pad) * 1.25) calc(var(--pad) * 1.5);
  }
  .current {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  .icon { font-size: 2rem; }
  .temp { display: flex; flex-direction: column; }
  .big { font-size: 1.8rem; font-weight: 700; }
  .desc, .wind { font-size: 0.9rem; color: var(--muted); }

  .forecast {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .day {
    display: grid;
    text-align: center;
    gap: 2px;
    background: #f7fafb;
    border-radius: 12px;
    padding: 6px;
  }
  .label { font-size: .85rem; color: var(--muted); }
  .range { font-weight: 600; }

  .fine {
    margin-top: 10px;
    font-size: .8rem;
    color: var(--muted);
  }
</style>
