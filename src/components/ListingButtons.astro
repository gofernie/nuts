---
type Btn = { label: string; href: string; test?: string };

const { items = [], raw = "" } = Astro.props;

const norm = (s:string) => (s || "").trim();
const isHttp = (u:string)=> /^https?:\/\//i.test(u);
const isSpecial = (u:string)=> u.startsWith("mailto:") || u.startsWith("tel:");
const sameOrigin = (u:string)=> !isHttp(u) && !isSpecial(u);

function titleFromHref(href:string){
  const seg = (href || "/").replace(/\/+$/,"").split("/").pop() || href;
  const words = seg.replace(/[-_]+/g," ").replace(/[^a-z0-9 ]/gi," ").trim();
  const nice = words.replace(/\s+/g," ").toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
  return nice || "View Listings";
}

function parseRaw(rawStr = ""): Btn[] {
  const s = norm(rawStr);
  if (!s) return [];
  const parts = s.split(/,|\n/).map(norm).filter(Boolean);
  const out: Btn[] = [];
  for (const part of parts) {
    if (part.includes("|")) {
      const [labelRaw, hrefRaw, testRaw] = part.split("|").map(norm);
      const href = hrefRaw || "";
      const label = labelRaw || titleFromHref(href);
      if (href) out.push({ label, href, test: testRaw || undefined });
    } else {
      const href = norm(part);
      if (href) out.push({ label: titleFromHref(href), href });
    }
  }
  const seen = new Set<string>();
  return out.filter(b => {
    const key = b.href.toLowerCase();
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

const fromRaw = parseRaw(raw);
const list: Btn[] = (items.length ? items : fromRaw).filter(b => norm(b.href));

const cur = Astro.url.pathname.replace(/\/+$/, "") || "/";
const isActive = (href: string, test?: string) => {
  const h = (href || "").replace(/\/+$/, "") || "/";
  if (test) { try { return new RegExp(test).test(cur); } catch {} }
  if (isHttp(h) || isSpecial(h)) return false;
  return cur === h;
};

if (list.length === 0) Astro.self.close();
---
<nav class="listing-buttons" aria-label="Listing filters">
  {list.map(({ label, href, test }) => {
    const active = isActive(href, test);
    return (
      <a
        class={`btn-link${active ? " is-active" : ""}`}
        href={href}
        aria-current={active ? "page" : undefined}
      >
        {label}
      </a>
    );
  })}
</nav>

<style>
  .btn-link.is-active {
    background: var(--color-primary-bg, #111);
    color: var(--color-on-primary, #fff);
    border-color: var(--color-primary-border, #111);
    font-weight: 600;
  }
</style>
