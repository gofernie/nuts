---
// File: src/pages/search/index.astro
import Site from "../../layouts/Site.astro";

const pageTitle = "Search Listings";
const pageSummary =
  "Find Fernie homes, condos, townhomes, and investment properties. Filter by price, beds, and more.";

const seo_title = "Search Fernie Real Estate Listings";
const seo_description =
  "Live Fernie MLSÂ® search: homes, condos, townhomes, investment properties. Filter and explore neighborhoods with up-to-date listings.";
---

<Site title={pageTitle} seo_title={seo_title} seo_description={seo_description}>
  <!-- (optional) intro space kept for consistency -->
  <div class="container intro"></div>

  <!-- RealtyVis Listings Embed (no extra padding/background; aligned to container) -->
  <section class="rv-section rv-nopad">
    <div class="container">
      <div id="rv-wrapper" class="rv-wrapper">
        <div data-rv-block="MQP2VMLT-14Y2W8DC"></div>
        <script src="https://cdn.realtyvis.com/js/embed.js" is:inline></script>
      </div>
    </div>
  </section>

  <!-- Scroll position save/restore -->
  <script is:inline>
    (() => {
      const getY = () => Math.max(window.scrollY, document.documentElement.scrollTop || 0);
      const writeState = (y) => {
        try {
          const cur = history.state && typeof history.state === 'object' ? history.state : {};
          if (cur.y === y) return;
          history.replaceState({ ...cur, y }, document.title, location.href);
        } catch {}
      };

      let raf = 0;
      addEventListener('scroll', () => {
        if (raf) return;
        raf = requestAnimationFrame(() => { raf = 0; writeState(getY()); });
      }, { passive: true });
      writeState(getY());

      const forceRestore = (y) => {
        if (!Number.isFinite(y)) return;
        const html = document.documentElement;
        const prev = html.style.scrollBehavior;
        html.style.scrollBehavior = 'auto';
        let tries = 0, max = 40;
        const tick = () => {
          window.scrollTo(0, y);
          if (++tries < max) requestAnimationFrame(tick);
          else html.style.scrollBehavior = prev || '';
        };
        requestAnimationFrame(tick);
      };

      addEventListener('popstate', (e) => {
        const y = e.state && typeof e.state === 'object' ? e.state.y : undefined;
        if (y != null) forceRestore(y);
      });
      addEventListener('pageshow', (e) => {
        if (e.persisted) {
          const y = history.state && typeof history.state === 'object' ? history.state.y : undefined;
          if (y != null) forceRestore(y);
        }
      });
      if (document.readyState !== 'loading') {
        const y = history.state && typeof history.state === 'object' ? history.state.y : undefined;
        if (y != null) forceRestore(y);
      } else {
        addEventListener('DOMContentLoaded', () => {
          const y = history.state && typeof history.state === 'object' ? history.state.y : undefined;
          if (y != null) forceRestore(y);
        });
      }
    })();
  </script>

  <!-- Runtime CSS injector to beat RV stylesheet load order in prod -->
  <script is:inline>
    (() => {
      const installRvFixes = () => {
        if (document.getElementById('rv-fix-css-runtime')) return;
        const css = `
#rv-wrapper{--rv-page-padding:0!important;--rv-container-padding:0!important;--rv-gutter-x:0!important;--rv-gutter-inline:0!important;overflow-x:clip}
.rv-section.rv-nopad{background:transparent!important;padding:0!important;margin:30px 0 0 0!important} /* 30px top space */
.rv-section.rv-nopad #rv-wrapper{background:transparent!important;border:0!important;box-shadow:none!important;border-radius:0!important;padding:0!important;margin:0!important;min-height:0!important}
#rv-wrapper .rv-block,
#rv-wrapper .rv-block .rv-gridView,
#rv-wrapper .rv-block .rv-filterView,
#rv-wrapper .rv-block .rv-results,
#rv-wrapper .rv-block .rv-content,
#rv-wrapper .rv-block .rv-items,
#rv-wrapper .rv-block .rv-root,
#rv-wrapper .rv-block .rv-container{margin-left:0!important;margin-right:0!important;padding-left:0!important;padding-right:0!important}
#rv-wrapper .rv-block:first-child{margin-top:0!important;padding-top:0!important}`;
        const tag = document.createElement('style');
        tag.id = 'rv-fix-css-runtime';
        tag.textContent = css;
        document.head.appendChild(tag);
      };
      installRvFixes();
      const mo = new MutationObserver(installRvFixes);
      mo.observe(document.documentElement, { childList: true, subtree: true });
      setTimeout(() => mo.disconnect(), 3000);
    })();
  </script>

  <style>
    /* Kill any hero space on this page */
    :global(.hero-bleed),
    :global(.hero-bleed img),
    :global(.hero-bleed::before),
    :global(.hero-bleed::after) {
      display: none !important;
      height: 0 !important;
      min-height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      content: none !important;
    }

    /* Page layout */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    .intro { margin-top: 24px; margin-bottom: 16px; }
  </style>

  <!-- Strong build-time overrides (runtime injector above ensures precedence in prod) -->
  <style is:global id="rv-fix-css">
    .rv-section.rv-nopad { background: transparent !important; padding: 0 !important; margin-top: 30px !important; }
    .rv-section.rv-nopad #rv-wrapper {
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      min-height: 0 !important;
    }
    #rv-wrapper {
      --rv-page-padding: 0 !important;
      --rv-container-padding: 0 !important;
      --rv-gutter-x: 0 !important;
      --rv-gutter-inline: 0 !important;
      overflow-x: clip;
    }
    #rv-wrapper .rv-block,
    #rv-wrapper .rv-block .rv-gridView,
    #rv-wrapper .rv-block .rv-filterView,
    #rv-wrapper .rv-block .rv-results,
    #rv-wrapper .rv-block .rv-content,
    #rv-wrapper .rv-block .rv-items,
    #rv-wrapper .rv-block .rv-root,
    #rv-wrapper .rv-block .rv-container {
      margin-left: 0 !important;
      margin-right: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }
    #rv-wrapper .rv-block:first-child { margin-top: 0 !important; padding-top: 0 !important; }
  </style>
</Site>
