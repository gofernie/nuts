---
// src/pages/neighbourhoods/[slug].astro
import Site from "../../layouts/Site.astro";
import { getJson } from "../../lib/fetchJson";

export async function getStaticPaths() {
  const url = import.meta.env.PUBLIC_SHEET_JSON;
  if (!url) return [];

  let rows: any[] = [];
  try {
    const raw = await getJson<any>(url);
    rows = Array.isArray(raw)
      ? raw
      : Array.isArray(raw?.data)
      ? raw.data
      : Array.isArray(raw?.rows)
      ? raw.rows
      : [];
  } catch (e) {
    console.error("Failed to fetch sheet JSON:", e);
    return [];
  }

  const items = rows
    .map((r: any) => {
      const get = (k: string) =>
        (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "")
          .toString()
          .trim();

      const title = get("title");
      if (!title) return null;

      const computedSlug = title
        .toLowerCase()
        .replace(/&/g, "-and-")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");

      return {
        slug: get("slug") || computedSlug,
        title,
        summary: get("summary"),
        hero_img: get("hero_img"),
        card_1: get("card_1"),
        card_2: get("card_2"),
        card_3: get("card_3"),
        map_embed: get("map_embed"),
        long_copy: get("long_copy"),
        cta1: get("cta1"),
        status: get("status"),
      };
    })
    .filter(
      (r) =>
        r &&
        r.slug &&
        r.title &&
        r.slug.toLowerCase() !== "index" &&
        !/^draft$/i.test(r.status || "")
    );

  return items.map((n: any) => ({
    params: { slug: n.slug },
    props: {
      title: n.title,
      summary: n.summary || "",
      hero: (() => {
        const s = (n.hero_img || "").trim();
        if (!s) return "";
        if (s.startsWith("http") || s.startsWith("/")) return s;
        if (/^img\//i.test(s)) return `/${s}`;
        if (/^hero\//i.test(s)) return `/img/${s}`;
        return `/img/hero/${s}`;
      })(),
      card_1: n.card_1 || "",
      card_2: n.card_2 || "",
      card_3: n.card_3 || "",
      cta1: n.cta1 || "",
      map_embed: (() => {
        const v = (n.map_embed || "").trim();
        if (!v) return "";
        const m = v.match(/src="([^"]+)"/i);
        if (m?.[1]) return m[1];
        if (v.includes("google.com/maps") && v.includes("embed")) return v;
        if (v.includes("google.com/maps")) {
          try {
            const u = new URL(v);
            const q = u.search ? `${u.search}&output=embed` : "?output=embed";
            return `https://www.google.com/maps${q}`;
          } catch {}
        }
        return `https://www.google.com/maps?q=${encodeURIComponent(v)}&output=embed`;
      })(),
      long_copy: n.long_copy || "",
    },
  }));
}

const { title, summary, hero, card_1, card_2, card_3, map_embed, long_copy, cta1 } =
  Astro.props as {
    title: string;
    summary: string;
    hero: string;
    card_1: string;
    card_2: string;
    card_3: string;
    map_embed: string;
    long_copy: string;
    cta1: string;
  };
---

<Site showHeader={true} title={title}>
  <!-- HERO -->
  <section
    class="hero-bleed"
    style={`${hero ? `background:url('${hero}') center/cover no-repeat` : "background:#f6f6f6"}`}
  ></section>

  <!-- TITLE + SUMMARY -->
  <div class="container intro">
    <h1>{title}</h1>
    {summary && <p>{summary}</p>}
  </div>

  <!-- FEATURE CARDS -->
  {(card_1 || card_2 || card_3) && (
    <div class="container features">
      {[card_1, card_2, card_3].filter(Boolean).map((c) => (
        <div class="feature">{c}</div>
      ))}
    </div>
  )}

  <!-- MAP -->
  {map_embed && (
    <div class="container map-wrap">
      <h2>Explore on the Map</h2>
      <div class="map-card">
        <iframe
          src={map_embed}
          title={`Map of ${title}`}
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"
        ></iframe>
      </div>
    </div>
  )}

  <!-- CTA -->
  {cta1 && (
    <div class="container">
      <div class="cta-card">
        <h2>Ready to explore {title} listings?</h2>
        <p>Browse every property and get instant alerts for price changes.</p>
        <a href={cta1} class="cta-btn"><span class="cta-text">ðŸ”Ž View Listings</span></a>
      </div>
    </div>
  )}

  <!-- LONG COPY -->
  {long_copy && (
    <div class="container">
      <article class="long-copy" set:html={long_copy}></article>
    </div>
  )}

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
    img, svg, video, canvas, audio, iframe, embed, object { display: block; max-width: 100%; height: auto; }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

    :root { --section-h: 42vh; }

    .hero-bleed {
      width: 100%;
      margin: 0;
      min-height: var(--section-h);
      border-bottom: 1px solid #eee;
      padding-top: var(--header-h);
    }

    .intro { margin-top: 24px; margin-bottom: 20px; }
    .intro h1 { font-size: 2.25rem; font-weight: 700; margin: 0 0 8px; color: #111827; }
    .intro p { font-size: 1rem; line-height: 1.6; color: #1f2937; }

    .features {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    @media (max-width: 860px) { .features { grid-template-columns: 1fr; } }
    .feature {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      border: 1px solid #eee;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      font-weight: 600;
    }

    /* Map fills container, matches hero height */
    .map-wrap h2 { font-size: 1.25rem; margin: 8px 0 12px; color: #111827; }
    .map-card {
      position: relative;
      width: 100%;
      height: var(--section-h);
      max-height: 720px;
      border: 1px solid #eee;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    }
    .map-card iframe {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    /* CTA */
    .cta-card {
      background: #fff;
      color: #111827;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 28px 20px;
      margin: 36px 0;
      text-align: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .cta-card h2 { margin: 0 0 10px; font-size: 1.75rem; font-weight: 700; }
    .cta-card p { font-size: 1rem; color: #374151; margin-bottom: 18px; }
    .cta-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #0a7bff;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.125rem;
      padding: 12px 28px;
      border-radius: 999px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: background 0.15s ease, box-shadow 0.15s ease;
    }
    .cta-btn .cta-text { text-decoration: none; }
    .cta-btn:hover {
      background: #065aa3;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }

    /* Long copy aligned to container width */
    .long-copy {
      margin: 40px 0 48px;
      font-size: 1.05rem;
      line-height: 1.8;
      color: #1f2937;
    }
    .long-copy p { margin: 0 0 1.25em; }
    .long-copy h2,
    .long-copy h3 {
      font-weight: 700;
      color: #111827;
      line-height: 1.3;
      margin: 2em 0 0.75em;
    }
    .long-copy h2 {
      font-size: 1.5rem;
      border-left: 4px solid #0a7bff;
      padding-left: 0.5rem;
    }
    .long-copy h3 { font-size: 1.25rem; }
    .long-copy ul, .long-copy ol {
      margin: 1em 0;
      padding-left: 1.5rem;
    }
    .long-copy li { margin-bottom: 0.5em; }
    .long-copy strong { font-weight: 600; color: #0a7bff; }
    .long-copy img {
      margin: 1.5em 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
  </style>
</Site>
