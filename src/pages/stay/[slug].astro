---
// File: src/pages/stay/[slug].astro
export const prerender = false;

import Site from "../../layouts/Site.astro";
import { getJson } from "../../lib/fetchJson";
import { heroPath } from "../../lib/paths";
import HeroBleed from "../../components/HeroBleed.astro";

const slugParam = (Astro.params.slug || "").toString().trim().toLowerCase();
const url = import.meta.env.PUBLIC_STAY_JSON;
if (!url) throw new Error("Missing PUBLIC_STAY_JSON in .env (restart dev).");

/* ---------- helpers ---------- */
const get = (r:any,k:string)=>
  (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "").toString().trim();

const slugify = (v:string) =>
  (v ?? "").toLowerCase().trim()
    .replace(/&/g,"-and-")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"");

const parseCard = (raw = "") => {
  const [title, subtitle, body, img, href] = (raw || "").split("|").map(s => s.trim());
  if (!title) return null;
  const normImg = img
    ? (img.startsWith("http") ? img : img.startsWith("/") ? img : "/heroes/" + img)
    : "";
  return { title, subtitle, body, img: normImg, href };
};

/* ---------- load & pick row ---------- */
let row:any = null;
try {
  const raw = await getJson<any>(url);
  const rows: any[] =
    Array.isArray(raw) ? raw :
    Array.isArray(raw?.data) ? raw.data :
    Array.isArray(raw?.rows) ? raw.rows : [];

  const normalized = rows.map((r:any) => {
    const title = get(r,"title");
    const explicitSlug = get(r,"slug").toLowerCase();
    const computedSlug = slugify(title || "");
    const status = get(r,"status");
    return {
      title,
      slug: explicitSlug || computedSlug,
      summary: get(r,"summary"),
      long_copy: get(r,"long_copy"),
      hero_img: get(r,"hero_img"),
      cta1: get(r,"cta1"),
      seo_title: get(r,"seo_title"),
      seo_description: get(r,"seo_description"),
      status,
      cards: [get(r,"card_1"), get(r,"card_2"), get(r,"card_3")].map(parseCard).filter(Boolean),
    };
  }).filter(n =>
    n.slug &&
    n.title &&
    n.slug !== "index" &&
    !/^draft$/i.test(n.status || "") &&
    !/^hidden$/i.test(n.status || "") &&
    !/^inactive$/i.test(n.status || "")
  );

  row =
    normalized.find(n => n.slug === slugParam) ||
    normalized.find(n => slugify(n.title) === slugParam) ||
    null;
} catch (e:any) {
  throw new Error("Failed to load stay row: " + (e?.message || String(e)));
}

if (!row) {
  throw new Error(`stay slug not found: "${slugParam}". Check your sheet's "slug" or "title".`);
}

const title          = row.title;
const summary        = row.summary || "";
const long_copy      = row.long_copy || "";
const hero           = row.hero_img ? heroPath(row.hero_img) : "";
const cta1           = row.cta1 || "";
const cards          = row.cards || [];
const pageSeoTitle   = row.seo_title || title || "Stay";
const pageSeoDesc    = row.seo_description || summary || "";
---

<Site showHeader={true} title={title} seo_title={pageSeoTitle} seo_description={pageSeoDesc}>
  {hero && (
    <HeroBleed
      src={hero}
      title={title}
      alt={title}
      preload
      height={{ min: 300, vw: 38, max: 520 }}
      gradient="linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0) 55%)"
      containerMax={1200}
      flush={true}
    />
  )}

  <div class="container intro">
    {summary && <article class="long-copy" set:html={summary}></article>}
  </div>

  {cards.length > 0 && (
    <div class="container">
      <div class="card-grid">
        {cards.map((c:any) => (
          <article class="tease">
            {c.img && <img class="tease-img" src={c.img} alt={c.title} width="1200" height="800" loading="lazy" decoding="async" />}
            <div class="tease-body">
              <h3 class="tease-title">{c.title}</h3>
              {c.subtitle && <p class="tease-sub">{c.subtitle}</p>}
              {c.body && <p class="tease-copy">{c.body}</p>}
              {c.href && <a class="tease-cta" href={c.href} aria-label={`Open ${c.title}`}>Learn more â†’</a>}
            </div>
          </article>
        ))}
      </div>
    </div>
  )}

  {cta1 && (
    <div class="container">
      <div class="cta-card">
        <h2>Book your stay at {title}</h2>
        <p>View availability, amenities, and more.</p>
        <a href={cta1} class="cta-btn"><span class="cta-text">Book now</span></a>
      </div>
    </div>
  )}

  {long_copy && (
    <div class="container">
      <article class="long-copy" set:html={long_copy}></article>
    </div>
  )}

  <style>
    :root { --container-max: 1200px; --container-pad: 1rem; }
    .container { max-width: var(--container-max); margin-inline: auto; padding-inline: var(--container-pad); }

    .intro { margin: 24px auto 20px; }
    .long-copy { margin: 12px 0 28px; font-size:1.05rem; line-height:1.8; color:#1f2937; }
    .long-copy p { margin: 0 0 1.25em; }
    .long-copy h2, .long-copy h3 { font-weight:700; color:#111827; line-height:1.3; margin:2em 0 .75em; }
    .long-copy h2 { font-size:1.5rem; border-left:4px solid #0a7bff; padding-left:.5rem; }
    .long-copy h3 { font-size:1.25rem; }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 20px;
      margin: 6px 0 24px;
    }
    @media (max-width: 1200px) { .card-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 900px)  { .card-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px)  { .card-grid { grid-template-columns: 1fr; } }

    .tease {
      background:#fff; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      display:flex; flex-direction:column;
    }
    .tease-img { width:100%; height:220px; object-fit:cover; display:block; }
    .tease-body { padding:16px 16px 18px; }
    .tease-title { margin:0 0 6px; font-size:1.15rem; color:#111827; }
    .tease-sub { margin:0 0 8px; color:#374151; font-weight:600; }
    .tease-copy { margin:0 0 12px; color:#374151; }
    .tease-cta { display:inline-flex; gap:6px; font-weight:700; text-decoration:none; color:#0a7bff; border-bottom:2px solid transparent; }
    .tease-cta:hover { border-bottom-color:#0a7bff; }

    .cta-card { margin: 24px 0; text-align:center; background:#f9fafb; padding:24px; border-radius:12px; }
    .cta-btn { background:#0a7bff; color:#fff; padding:12px 20px; display:inline-block; border-radius:8px; text-decoration:none; font-weight:600; }
    .cta-btn:hover { background:#095ed0; }
  </style>
</Site>
