/** File: src/pages/stay/index.astro */
import Site from "../../layouts/Site.astro";
import HeroBleed from "../../components/HeroBleed.astro";
import { getJson } from "../../lib/fetchJson";
import { heroPath } from "../../lib/paths";

const PATH_BASE = "/stay";

/* ---------- helpers ---------- */
const RESERVED = new Set(["index","page","pages","all","view","list"]);
const get = (r:any,k:string)=>
  (r?.[k] ?? r?.[k?.toLowerCase?.()] ?? r?.[k?.toUpperCase?.()] ?? "").toString().trim();

const slugify = (v:string) =>
  (v ?? "").toLowerCase().trim()
    .replace(/&/g,"-and-")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"");

const visible = (r:any) => {
  const s = get(r,"status").toLowerCase();
  const rawSlug = get(r,"slug").toLowerCase();
  return s !== "hidden" && s !== "inactive" && rawSlug !== "index" && !RESERVED.has(rawSlug);
};

type Row = {
  slug?: string;
  title?: string;
  summary?: string;
  long_copy?: string;
  hero_img?: string;
  status?: string;
  seo_title?: string;
  seo_description?: string;
  sort?: number|string;
};

let items: Row[] = [];
let header: Row | null = null;
let error: string | null = null;

try {
  const url = import.meta.env.PUBLIC_STAY_JSON;
  if (!url) throw new Error("Missing PUBLIC_STAY_JSON in .env (restart dev).");

  const raw = await getJson<any>(url);
  const rows:any[] =
    Array.isArray(raw) ? raw :
    Array.isArray(raw?.data) ? raw.data :
    Array.isArray(raw?.rows) ? raw.rows : [];

  header = rows.find(r => get(r,"slug").toLowerCase() === "index") ?? null;

  items = rows
    .filter(r => visible(r))
    .map(r => ({
      slug: get(r,"slug") || slugify(get(r,"title")),
      title: get(r,"title"),
      summary: get(r,"summary"),
      hero_img: get(r,"hero_img"),
      sort: +get(r,"sort") || Number.MAX_SAFE_INTEGER,
      seo_title: get(r,"seo_title"),
      seo_description: get(r,"seo_description"),
    }))
    .filter(r => r.slug && r.title)
    .sort((a,b) => (Number(a.sort) - Number(b.sort)) || a.title!.localeCompare(b.title!));

} catch (e:any) {
  error = e?.message || "Failed to load data.";
}

const pageTitle = get(header,"title") || "Places to Stay in Fernie";
const pageSummary = get(header,"summary");
const heroImg = get(header,"hero_img");
const seoTitle = get(header,"seo_title") || pageTitle;
const seoDesc  = get(header,"seo_description") || pageSummary;
---

<Site title={seoTitle} seo_title={seoTitle} seo_description={seoDesc}>
  <HeroBleed
    src={heroImg ? heroPath(heroImg) : ""}
    title={pageTitle}
    containerMax={1200}
    flush={false}
    containerPad={12}
  />

  <div class="container">
    {pageSummary && <p class="lead">{pageSummary}</p>}
    {error && <p class="err">{error}</p>}

    {!error && (
      <div class="grid">
        {items.map((it) => (
          <a class="card" href={`${PATH_BASE}/${it.slug}`} data-astro-prefetch="hover">
            {it.hero_img && (
              <img src={heroPath(it.hero_img)} alt={it.title} loading="lazy" decoding="async" />
            )}
            <div class="body">
              <h2>{it.title}</h2>
              {it.summary && <p>{it.summary}</p>}
            </div>
          </a>
        ))}
      </div>
    )}
  </div>

  <style>
    .lead{ margin: 0 0 1.25rem; font-size: 1.05rem; line-height: 1.6; color:#111827; }
    .err{ color:#b91c1c; background:#fee2e2; padding:.75rem 1rem; border-radius:.5rem; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 16px;
    }
    @media (max-width:1200px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:900px){  .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:560px){  .grid{ grid-template-columns: 1fr; } }

    .card{
      display:flex; flex-direction:column;
      background:#fff; border:1px solid #e5e7eb; border-radius:14px;
      overflow:hidden; text-decoration:none; color:inherit;
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .card:hover{ transform: translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.08); border-color:#d1d5db; }
    .card img{ width:100%; aspect-ratio: 16/9; object-fit: cover; display:block; }
    .card .body{ padding:12px; }
    .card .body h2{ margin:0 0 6px; font-size:1.05rem; line-height:1.3; }
    .card .body p{
      margin:0; color:#374151; line-height:var(--card-text-lh,1.35);
      display:-webkit-box; -webkit-line-clamp:var(--card-text-lines,3); -webkit-box-orient:vertical; overflow:hidden;
    }
  </style>
</Site>
